<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Face Track Mobile</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: sans-serif;
            touch-action: none; /* Previene lo scroll su mobile */
        }
        
        #output_canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 1;
        }

        /* Video nascosto per il debug */
        .debug-container {
            position: absolute;
            bottom: 10px; right: 10px;
            width: 100px; height: 133px; /* Aspect ratio portrait */
            z-index: 2;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            overflow: hidden;
            opacity: 0.6;
            pointer-events: none;
        }
        #input_video {
            width: 100%; height: 100%;
            transform: scaleX(-1);
            object-fit: cover;
        }
        
        /* Overlay per il pulsante di avvio */
        #start-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 99;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: #00ffcc;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>Tracking Facciale 3D</h1>
        <p>Muovi la testa per guardare dentro il cubo.</p>
        <button id="start-btn">AVVIA FOTOCAMERA</button>
        <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">Richiede permessi webcam</p>
    </div>

    <canvas id="output_canvas"></canvas>

    <div class="debug-container">
        <video id="input_video" playsinline muted autoplay></video>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { FaceMesh } from 'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/+esm';
        import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1632432244/+esm';

        // --- Configurazione Mobile ---
        const SENSITIVITY_X = 8.0; // Più sensibile su mobile
        const SENSITIVITY_Y = 5.0;
        
        // --- Setup Three.js ---
        const canvas = document.getElementById('output_canvas');
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Ottimizzazione performance

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        // Luci
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x00ffcc, 40);
        pointLight.position.set(2, 2, 5);
        scene.add(pointLight);

        // Oggetto 3D
        const geometry = new THREE.IcosahedronGeometry(1.5, 0);
        const material = new THREE.MeshStandardMaterial({ 
            color: 0x222222, roughness: 0.2, metalness: 0.9, wireframe: false 
        });
        const mainObj = new THREE.Mesh(geometry, material);
        
        const wireGeo = new THREE.IcosahedronGeometry(2.5, 1);
        const wireMat = new THREE.LineBasicMaterial({ color: 0xff0055, transparent: true, opacity: 0.3 });
        const wireframe = new THREE.LineSegments(new THREE.WireframeGeometry(wireGeo), wireMat);
        
        const group = new THREE.Group();
        group.add(mainObj);
        group.add(wireframe);
        scene.add(group);

        // Griglia di sfondo per riferimento profondità
        const grid = new THREE.GridHelper(30, 30, 0x444444, 0x111111);
        grid.rotation.x = Math.PI / 2; // Griglia verticale dietro
        grid.position.z = -10;
        scene.add(grid);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 10;

        // --- Tracking Logic ---
        let targetX = 0;
        let targetY = 0;
        const videoElement = document.getElementById('input_video');

        // Inizializzazione MediaPipe
        const faceMesh = new FaceMesh({locateFile: (file) => 
            `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            
        faceMesh.setOptions({
            maxNumFaces: 1,
            refineLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        faceMesh.onResults((results) => {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const nose = results.multiFaceLandmarks[0][1];
                
                // Calcolo posizione (invertita per effetto specchio naturale)
                let x = (nose.x - 0.5); 
                let y = (nose.y - 0.5);

                targetX = -x * SENSITIVITY_X; 
                targetY = -y * SENSITIVITY_Y;
            }
        });

        // --- Gestione Avvio (Importante per iOS/Android) ---
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');

        startBtn.addEventListener('click', async () => {
            startBtn.innerText = "Caricamento...";
            
            // Setup Camera Utils con facingMode 'user'
            const cameraFeed = new Camera(videoElement, {
                onFrame: async () => {
                    await faceMesh.send({image: videoElement});
                },
                width: 480,  // Risoluzione ridotta per performance mobile
                height: 640,
                facingMode: 'user' // <--- QUESTA È LA CHIAVE PER LA CAM FRONTALE
            });

            try {
                await cameraFeed.start();
                overlay.style.display = 'none'; // Nascondi overlay solo se ha successo
            } catch (e) {
                alert("Errore accesso fotocamera: " + e.message);
                startBtn.innerText = "Riprova";
            }
        });

        // --- Loop Animazione ---
        function animate() {
            requestAnimationFrame(animate);

            // Interpolazione fluida (Lerp)
            camera.position.x += (targetX - camera.position.x) * 0.1;
            camera.position.y += (targetY - camera.position.y) * 0.1;
            camera.lookAt(0, 0, 0);

            // Rotazione lenta oggetto
            group.rotation.y += 0.005;
            group.rotation.z += 0.002;

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
