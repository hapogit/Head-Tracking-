<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Debug 3D</title>
    <style>
        body { background: #111; color: white; font-family: monospace; margin: 0; padding: 20px; }
        #console-log {
            background: #000; border: 1px solid #333; padding: 10px;
            height: 200px; overflow-y: scroll; font-size: 12px; margin-bottom: 20px;
        }
        button {
            background: #00ffcc; border: none; padding: 15px 30px; 
            font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; width: 100%;
        }
        #output_canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }
        video { opacity: 0; position: absolute; width: 1px; height: 1px; }
    </style>
</head>
<body>

    <h3>Console di Debug</h3>
    <div id="console-log">In attesa...</div>
    <button id="start-btn">AVVIA FOTOCAMERA</button>
    <p>Se non vedi nulla dopo il click, controlla le impostazioni privacy del browser.</p>

    <canvas id="output_canvas"></canvas>
    <video id="input_video" playsinline muted autoplay></video>

    <script>
        const logBox = document.getElementById('console-log');
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<div>[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        window.onerror = function (msg, url, lineNo, columnNo, error) {
            log(`‚ùå ERRORE GLOBALE: ${msg} (Riga: ${lineNo})`);
            return false;
        };

        log("‚ÑπÔ∏è Pagina caricata. Controllo supporto browser...");

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            log("‚ùå ERRORE CRITICO: navigator.mediaDevices non supportato! Sei su HTTPS?");
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').innerText = "BROWSER NON SUPPORTATO";
        } else {
            log("‚úÖ Supporto API Camera rilevato.");
        }
    </script>

    <script type="module">
        log("‚ÑπÔ∏è Inizio caricamento moduli Three/MediaPipe...");
        
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
        import { FaceMesh } from 'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/+esm';

        log("‚úÖ Moduli caricati con successo.");

        // --- Variabili ---
        let targetX = 0, targetY = 0;
        const videoElement = document.getElementById('input_video');
        const startBtn = document.getElementById('start-btn');
        let faceMesh;

        // --- Setup Three.js ---
        const canvas = document.getElementById('output_canvas');
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 5;
        
        const geometry = new THREE.IcosahedronGeometry(1, 1);
        const material = new THREE.MeshNormalMaterial({ wireframe: true });
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);

        function animate() {
            requestAnimationFrame(animate);
            camera.position.x += (targetX - camera.position.x) * 0.1;
            camera.position.y += (targetY - camera.position.y) * 0.1;
            camera.lookAt(0,0,0);
            cube.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        animate();
        log("‚úÖ Rendering 3D avviato.");

        // --- Setup MediaPipe ---
        try {
            faceMesh = new FaceMesh({locateFile: (file) => 
                `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            
            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh.onResults((results) => {
                if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                    const nose = results.multiFaceLandmarks[0][1];
                    targetX = -(nose.x - 0.5) * 5; 
                    targetY = -(nose.y - 0.5) * 5;
                }
            });
            log("‚úÖ MediaPipe configurato.");
        } catch(e) {
            log("‚ùå Errore config MediaPipe: " + e.message);
        }

        // --- Gestione Bottone ---
        startBtn.addEventListener('click', async () => {
            log("üîÑ Pulsante premuto. Richiesta stream...");
            
            try {
                // Tenta prima la cam frontale, poi qualsiasi cam
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 },
                    audio: false
                });

                log("‚úÖ Stream ottenuto! Collegamento al video...");
                videoElement.srcObject = stream;
                
                videoElement.onloadeddata = () => {
                    log("‚úÖ Video caricato. Avvio analisi...");
                    startBtn.style.display = 'none'; // Nascondi bottone
                    processVideo();
                };

            } catch (err) {
                log(`‚ùå ERRORE CAMERA: ${err.name}`);
                log(`Dettaglio: ${err.message}`);
                if (err.name === 'NotAllowedError') {
                    alert("HAI NEGATO IL PERMESSO! Devi resettare i permessi del sito nelle impostazioni del browser.");
                }
            }
        });

        async function processVideo() {
            if (!videoElement.paused && !videoElement.ended) {
                await faceMesh.send({image: videoElement});
                requestAnimationFrame(processVideo);
            }
        }

    </script>
</body>
</html>
